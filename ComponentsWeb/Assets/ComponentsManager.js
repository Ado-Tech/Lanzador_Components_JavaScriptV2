const SUCCESS_MSJ="SUCCESS";var config,stylesLivenessLoaded=null,clientLivenessLoaded=null,CASE_ID=null,NEW_UID_DEVICE=null;const VERSION_COMPONENT=1,SUCCESS=1,ERROR_LIVENESS=2,ERROR_CARD_CAPTURE=3,ERROR_TOKEN=4;async function Start(e,a,t,n,o,s,r,i,l,c){try{(function(e,a,t,n,o,s){CASE_ID="xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var a=16*Math.random()|0,t="x"==e?a:3&a|8;return t.toString(16)}),NEW_UID_DEVICE="xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var a=16*Math.random()|0,t="x"==e?a:3&a|8;return t.toString(16)});var i="",l=!0;s&&0!==s.length||(r=NEW_UID_DEVICE);e&&0!==e.length||(i=`${i} The param urlBase is required`);a&&0!==a.length||(i=`${i} The param projectName is required`);t&&0!==t.length||(i=`${i} The param apiKey is required`);n&&0!==n.length||(i=`${i} The param productId is required`);(!o||0==o||o>2)&&(i=`${i} The param functionCapture is empty or not valid`);""!=i&&(l=!1,u(ERROR_TOKEN,null,i));return l})(e,a,t,n,o,r)&&null!=(config=await async function(){try{const o=await fetch(`${e}/api/${a}/GetConfig?Message=none`,{method:"POST",headers:{apiKey:t,productId:n},redirect:"follow"});return o.ok?await o.json():(u(ERROR_TOKEN,null,"invalidCredentials"),null)}catch(e){"Failed to fetch"===e.message?u(ERROR_TOKEN,null,"connectionError",!1):u(ERROR_TOKEN,null,"invalidParameters",!1)}}())&&(1==o?function(){let n={url:config.UrlNewServiceLiveness,extraData:{caseId:CASE_ID,clientTranslationFileName:config.ConfigFileLiveness,flowConfigName:config.ConfigGeneralFileLiveness,libraryName:"LIVENESS"}},o=`${config.UrlNewServiceLiveness}/demo?is_iframe=true&params=`+encodeURIComponent(JSON.stringify(n)),s=document.createElement("iframe");s.setAttribute("id","liveness-iframe"),s.setAttribute("allow","camera *;microphone *"),s.setAttribute("style","width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 2;"),s.setAttribute("src",o),document.body.appendChild(s);const r=window.addEventListener?"addEventListener":"attachEvent";(0,window[r])("attachEvent"===r?"onmessage":"message",async function n(o){const r=JSON.parse(o.data);switch(r.status){case"success":console.log("Liveness success");var i=r.stages.filter(e=>"passive"==e.stage.type),l=i[0].payload.score;console.log("Score liveness"+l);var c=parseFloat(String(config.LivenessThreshold).replace(",","."));if(console.log("Score validation"+c),l>c){let n=await async function(n){var o=new Headers;o.append("apiKey",t),o.append("Content-Type","application/json");var s=JSON.stringify({Image:n,GetFeatures:!0,GetTemplate:!1}),r={method:"POST",headers:o,body:s,redirect:"follow"};let i=await fetch(`${e}/api/GetFacialFeatures?projectName=${a}`,r);return i.ok?await i.json():(console.log(i.statusText),null)}(r.stages[0].payload.images.face_image);!function(e){return!(e.Response.lstResults[0].Blink||e.Response.lstResults[0].MouthOpen||e.Response.lstResults[0].Glasses||e.Response.lstResults[0].DarkGlasses)}(n)?(console.log("Image is not valid"),u(ERROR_LIVENESS,null,"livenessFailed")):(console.log("Image is valid"),u(SUCCESS,r.stages[0].payload.images.face_image,SUCCESS_MSJ))}else u(ERROR_LIVENESS,null,"livenessFailed");break;case"failure":default:console.log("Liveness Fail"),u(ERROR_LIVENESS,null,"livenessFailed")}document.body.removeChild(s),window.removeEventListener("onmessage",n,!1),window.removeEventListener("message",n,!1)},!1)}():2==o&&function(){const e={SHOW_RESULTS:!1,NUMBER_OF_IMAGES:1,POPUP_TEXT:"Capturar Cara posterior",POSITION_INSTRUCTION_FRONT_SIDE:s?config.ConfigurationUI.CardCaptureUI.CaptureFrontInstructionsText:config.ConfigurationUI.CardCaptureUI.CaptureBackInstructionsText,POSITION_INSTRUCTION_BACK_SIDE:config.ConfigurationUI.CardCaptureUI.CaptureBackInstructionsText,SIDE_A:"Side A",SIDE_B:"Side B",RESULTS_PAGE_TITLE:"Confirmar Foto",RESULTS_CONDITIONS_TITLE:"Make Sure:",CONDITIONS:[{CONDITION:"Se escaneó toda la identificación"},{CONDITION:"Sin deslumbramiento en la identificación"},{CONDITION:"El texto es legible."}],CONFIRM_BUTTON:"OK",TRY_AGAIN_BUTTON:"Inténtalo de nuevo",COLORS:{positionInstructionTextBackground:config.ConfigurationUI.CardCaptureUI.InstructionsBackgroundColor,instructionsTextColor:config.ConfigurationUI.CardCaptureUI.InstructionsColor,instructionsColor:config.ConfigurationUI.CardCaptureUI.InstructionsColor,loaderColor:config.ConfigurationUI.CardCaptureUI.BackArrowColor,popupBackgroundColor:"white",popupTextColor:"red",primaryColor:config.ConfigurationUI.CardCaptureUI.MainColor,backArrow:config.ConfigurationUI.CardCaptureUI.BackArrowColor},FONT:"'Roboto', sans-serif"};let a;try{e.NUMBER_OF_IMAGES=1,(a=scanovate_card_capture()).destroyFirstPage(e.KILL_STREAM_AFTER_USAGE),a.destroySecondPage(),a.init(e),document.getElementById("back-button").addEventListener("click",function(){u(ERROR_CARD_CAPTURE,null,"userCanceled")}),a.on("error",t=>{console.log(`Error name: ${t&&t.name}, message: ${t&&t.message}`),a.destroyFirstPage(e.KILL_STREAM_AFTER_USAGE),a.destroySecondPage(),"ScanovateCameraError"==t.name?u(ERROR_CARD_CAPTURE,null,"canNotOpenCamera"):u(ERROR_CARD_CAPTURE,null,"exception")}),a.on("success",t=>{a.destroyFirstPage(e.KILL_STREAM_AFTER_USAGE),a.destroySecondPage();var n=t.firstCapture;n=n.replace("data:image/jpeg;base64,",""),u(SUCCESS,n,SUCCESS_MSJ)})}catch(e){u(ERROR_CARD_CAPTURE,null,"exception")}}())}catch(e){u(ERROR_TOKEN,null,e.message)}function u(n,s,u,d=!0){var C={};C.StatusCode=n,C.Image=s,C.UIdDevice=r,C.keyProcessLiveness=CASE_ID,C.Message=u,d?async function(n,s,u){try{var d={};d.StatusCode=n,d.Image=null,d.UIdDevice=r,d.keyProcessLiveness=CASE_ID,d.SourceDevice=4,d.BrowserVersion=navigator.appVersion,d.OS=null,d.Message="Could not send record";var C=new Headers;C.append("apiKey",t),C.append("Authorization",i),C.append("Content-Type","application/json");var E=JSON.stringify({Service:o,SourceDevice:"4",Status:n==ERROR_LIVENESS||n==ERROR_CARD_CAPTURE||n==ERROR_TOKEN?2:1,SdkVersion:VERSION_COMPONENT,BrowserVersion:navigator.appVersion,UIdDevice:r,Message:s}),S={method:"POST",headers:C,body:E,redirect:"follow"};const R=await fetch(e+"/api/"+a+"/RegisterLogComponents",S);R.ok?u.StatusCode==SUCCESS?l(u):c(u):(401==R.status&&(d.Message="invalidCredentials",u.Message="invalidCredentials",u.StatusCode=ERROR_TOKEN),401==R.status&&(d.Message="tokenError",u.Message="tokenError",u.StatusCode=ERROR_TOKEN),c(u))}catch(e){"Failed to fetch"===e.message&&(d.message="connectionError"),d.message=e.message,c(d)}}(n,u,C):c(C)}}
