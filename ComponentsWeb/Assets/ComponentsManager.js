const SUCCESS_MSJ="SUCCESS";var config,stylesLivenessLoaded=null,clientLivenessLoaded=null,CASE_ID=null,NEW_UID_DEVICE=null;const VERSION_COMPONENT=1,SUCCESS=1,ERROR_LIVENESS=2,ERROR_CARD_CAPTURE=3,ERROR_TOKEN=4,E_LIVENESS_TYPE={SCANNOVATE_LIVENESS:1,IPROOV_LIVENESS:2,LIVE_PICTURE:3,SCANNOVATE_NEW_LIVENESS:4};async function Start(e,n,o,i,s,t,r,a,c,l){try{(function(e,n,o,i,s,t){CASE_ID="xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,(function(e){var n=16*Math.random()|0;return("x"==e?n:3&n|8).toString(16)})),NEW_UID_DEVICE="xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,(function(e){var n=16*Math.random()|0;return("x"==e?n:3&n|8).toString(16)}));var a="",c=!0;t&&0!==t.length||(r=NEW_UID_DEVICE);e&&0!==e.length||(a=`${a} The param urlBase is required`);n&&0!==n.length||(a=`${a} The param projectName is required`);o&&0!==o.length||(a=`${a} The param apiKey is required`);i&&0!==i.length||(a=`${a} The param productId is required`);(!s||0==s||s>2)&&(a=`${a} The param functionCapture is empty or not valid`);""!=a&&(c=!1,u(4,null,a));return c})(e,n,o,i,s,r)&&null!=(config=await async function(){try{const s=await fetch(`${e}/api/${n}/GetConfig?Message=none`,{method:"POST",headers:{apiKey:o,productId:i},redirect:"follow"});return s.ok?await s.json():(u(4,null,"invalidCredentials"),null)}catch(e){"Failed to fetch"===e.message?u(4,null,"connectionError",!1):u(4,null,"invalidParameters",!1)}}())&&(1==s?(config.TypeLiveness==E_LIVENESS_TYPE.SCANNOVATE_LIVENESS&&function(){null!=stylesLivenessLoaded&&0!=stylesLivenessLoaded||(e=`${config.UrlServiceLiveness}/client/assets/main.css`,n=document.getElementsByTagName("head")[0],(o=document.createElement("link")).async=!1,o.rel="stylesheet",o.type="text/css",o.href=e,o.media="all",o.onload=function(){d(clientLivenessLoaded,stylesLivenessLoaded=!0)},o.onerror=function(e){stylesLivenessLoaded=!1},n.appendChild(o));var e,n,o;!async function(e){var n=document.createElement("script");n.setAttribute("src",e),n.async=!1,n.onload=function(){d(clientLivenessLoaded=!0,stylesLivenessLoaded)},n.onerror=function(){clientLivenessLoaded=!1},document.body.appendChild(n)}(`${config.UrlServiceLiveness}/client/script.js`)}(),config.TypeLiveness==E_LIVENESS_TYPE.SCANNOVATE_NEW_LIVENESS&&function(){let i={url:config.UrlNewServiceLiveness,extraData:{caseId:CASE_ID,clientTranslationFileName:config.ConfigFileLiveness,flowConfigName:config.ConfigGeneralFileLiveness,libraryName:"LIVENESS"}},s=`${config.UrlNewServiceLiveness}/demo?is_iframe=true&params=`+encodeURIComponent(JSON.stringify(i)),t=document.createElement("iframe");t.setAttribute("id","liveness-iframe"),t.setAttribute("allow","camera *;microphone *"),t.setAttribute("style","width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 2;"),t.setAttribute("src",s),document.body.appendChild(t);const r=window.addEventListener?"addEventListener":"attachEvent",a=window[r];a("attachEvent"===r?"onmessage":"message",(async function i(s){const r=JSON.parse(s.data);if("success"===r.status)if(r.stages.filter((e=>"passive"==e.stage.type))[0].payload.score>parseFloat(String(config.LivenessThreshold).replace(",",".")))if(config.GetFacialFeatures){!function(e){return!(e.Response.lstResults[0].Blink||e.Response.lstResults[0].MouthOpen||e.Response.lstResults[0].Glasses||e.Response.lstResults[0].DarkGlasses)}(await async function(i){var s=new Headers;s.append("apiKey",o),s.append("Content-Type","application/json");var t=JSON.stringify({Image:i,GetFeatures:!0,GetTemplate:!1}),r={method:"POST",headers:s,body:t,redirect:"follow"};let a=await fetch(`${e}/api/GetFacialFeatures?projectName=${n}`,r);return a.ok?await a.json():(console.log(a.statusText),null)}(r.stages[0].payload.images.face_image))?u(2,null,"livenessFailed"):u(1,r.stages[0].payload.images.face_image,"SUCCESS")}else u(1,r.stages[0].payload.images.face_image,"SUCCESS");else u(2,null,"livenessFailed");else console.log("Liveness Fail"),u(2,null,"livenessFailed");console.log("iframe element removed"),document.body.removeChild(t),window.removeEventListener("onmessage",i,!1),window.removeEventListener("message",i,!1)}),!1)}()):2==s&&function(){const e={SHOW_RESULTS:!1,NUMBER_OF_IMAGES:1,POPUP_TEXT:"Capturar Cara posterior",POSITION_INSTRUCTION_FRONT_SIDE:t?config.ConfigurationUI.CardCaptureUI.CaptureFrontInstructionsText:config.ConfigurationUI.CardCaptureUI.CaptureBackInstructionsText,POSITION_INSTRUCTION_BACK_SIDE:config.ConfigurationUI.CardCaptureUI.CaptureBackInstructionsText,SIDE_A:"Side A",SIDE_B:"Side B",RESULTS_PAGE_TITLE:"Confirmar Foto",RESULTS_CONDITIONS_TITLE:"Make Sure:",CONDITIONS:[{CONDITION:"Se escaneó toda la identificación"},{CONDITION:"Sin deslumbramiento en la identificación"},{CONDITION:"El texto es legible."}],CONFIRM_BUTTON:"OK",TRY_AGAIN_BUTTON:"Inténtalo de nuevo",COLORS:{positionInstructionTextBackground:config.ConfigurationUI.CardCaptureUI.InstructionsBackgroundColor,instructionsTextColor:config.ConfigurationUI.CardCaptureUI.InstructionsColor,instructionsColor:config.ConfigurationUI.CardCaptureUI.InstructionsColor,loaderColor:config.ConfigurationUI.CardCaptureUI.BackArrowColor,popupBackgroundColor:"white",popupTextColor:"red",primaryColor:config.ConfigurationUI.CardCaptureUI.MainColor,backArrow:config.ConfigurationUI.CardCaptureUI.BackArrowColor},FONT:"'Roboto', sans-serif"};let n;try{e.NUMBER_OF_IMAGES=1,n=scanovate_card_capture(),n.destroyFirstPage(e.KILL_STREAM_AFTER_USAGE),n.destroySecondPage(),n.init(e),document.getElementById("back-button").addEventListener("click",(function(){u(3,null,"userCanceled")})),n.on("error",(o=>{console.log(`Error name: ${o&&o.name}, message: ${o&&o.message}`),n.destroyFirstPage(e.KILL_STREAM_AFTER_USAGE),n.destroySecondPage(),"ScanovateCameraError"==o.name?u(3,null,"canNotOpenCamera"):u(3,null,"exception")})),n.on("success",(o=>{n.destroyFirstPage(e.KILL_STREAM_AFTER_USAGE),n.destroySecondPage();var i=o.firstCapture;u(1,i=i.replace("data:image/jpeg;base64,",""),"SUCCESS")}))}catch(e){u(3,null,"exception")}}())}catch(e){u(4,null,e.message)}function u(i,t,u,d=!0){var g={};g.StatusCode=i,g.Image=t,g.UIdDevice=r,g.keyProcessLiveness=CASE_ID,g.Message=u,d?async function(i,t,u){try{var d={};d.StatusCode=i,d.Image=null,d.UIdDevice=r,d.keyProcessLiveness=CASE_ID,d.SourceDevice=4,d.BrowserVersion=navigator.appVersion,d.OS=null,d.Message="Could not send record";var g=new Headers;g.append("apiKey",o),g.append("Authorization",a),g.append("Content-Type","application/json");var C={method:"POST",headers:g,body:JSON.stringify({Service:s,SourceDevice:"4",Status:2==i||3==i||4==i?2:1,SdkVersion:1,BrowserVersion:navigator.appVersion,UIdDevice:r,Message:t}),redirect:"follow"};const I=await fetch(e+"/api/"+n+"/RegisterLogComponents",C);I.ok?1==u.StatusCode?c(u):l(u):(401==I.status&&(d.Message="invalidCredentials",u.Message="invalidCredentials",u.StatusCode=4),401==I.status&&(d.Message="tokenError",u.Message="tokenError",u.StatusCode=4),l(u))}catch(e){"Failed to fetch"===e.message&&(d.message="connectionError"),d.message=e.message,l(d)}}(i,u,g):l(g)}function d(e,n){if(e&&n)try{var o;const e={connect:"connect",connectError:"connect_error",disconnect:"disconnect",faceImage:"face_image",libraryReady:"library_ready",serverError:"serverError",socketError:"socket_error",status:"status"},n={landscapeModeAllowed:!0,devMode:!1,disableAudioPermissionRequest:!0,successSoundUrl:config.UrlServiceLiveness+"/client/assets/audio/sn_v_sound.mp3",language:"es",cameraDirection:1==config.SecondCamera?"environment":"",customMessages:{ALIGN_FACE:config.ConfigurationUI.LivenessUI.OngoingAlignFaceText,ALIGN_FACE_SUB:" ",LOOK_CENTER:config.ConfigurationUI.LivenessUI.LookAtCenterText,LOOK_CENTER_SUB:" ",LOOK_LEFT:config.ConfigurationUI.LivenessUI.LookLeftText,LOOK_LEFT_SUB:" ",FACE_OFF_CENTER:config.ConfigurationUI.LivenessUI.OngoingAlignFaceText,FACE_OFF_CENTER_SUB:" ",LOOK_RIGHT:config.ConfigurationUI.LivenessUI.LookRightText,LOOK_RIGHT_SUB:" ",FACE_TOO_FAR:config.ConfigurationUI.LivenessUI.ComeCloserText,FACE_TOO_FAR_SUB:" ",FACE_TOO_CLOSE:config.ConfigurationUI.LivenessUI.GetFurtherText,FACE_TOO_CLOSE_SUB:" ",TOO_MANY_FACES:config.ConfigurationUI.LivenessUI.MultipleFacesFoundText,TOO_MANY_FACES_SUB:" ",START_PASSIVE_CHECK:config.ConfigurationUI.LivenessUI.SessionEndedSuccessfullyText,START_PASSIVE_CHECK_SUB:" "},instructions:{position:1==config.ConfigurationUI.LivenessUI.InstructionsPosition?"top":"bottom",fontFamily:"'Rubik', 'Roboto', 'Open Sans', 'Lucida Grande', sans-serif'",fontSize:"24px",subFontFamily:"'Rubik', 'Roboto', 'Open Sans', 'Lucida Grande', sans-serif'",subFontSize:"18px",underlineColor:config.ConfigurationUI.LivenessUI.UnderlineColorResource},successSign:{color:config.ConfigurationUI.LivenessUI.SuccessSignColor,backgroundColor:config.ConfigurationUI.LivenessUI.SuccessSignBackgroundColor},passiveCheckProgressBar:{color:config.ConfigurationUI.LivenessUI.LoaderColorResource,backgroundColor:config.ConfigurationUI.LivenessUI.SuccessSignBackgroundColor},directionSign:{color:config.ConfigurationUI.LivenessUI.DirectingArrowsColor,shape:1==config.ConfigurationUI.LivenessUI.DirectionSignShape?"arrow":"triangle"},loader:{color:config.ConfigurationUI.LivenessUI.LoaderColorResource}},i=`${CASE_ID}`,s=config.UrlServiceLiveness,t=lacs.connect(s,i,{path:"/liveness/v1/",query:{token:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c",caseId:i}},n);lacs.plugins.frameRecorder.init(t),t.bindContainer(document.getElementById("livenessContainer")),generateInitLibraryPromise=function(){return new Promise((e=>{t.on("library_ready",(function(n){e()}))}))};let r=generateInitLibraryPromise();const a=function(){console.log("reconnecting to server!"),t.initSocketWithCurrentConfig()};t.on(e.connect,(()=>{t.setWebHookParams({system:1,caseId:i})})),t.on(e.disconnect,(e=>{console.log("Socket disconnected"),"io server disconnect"===e&&(console.log("server sent disconnect!"),r=generateInitLibraryPromise(),a())})),t.on(e.connectError,(()=>{u(2,null,"connectionError")})),t.on(e.socketError,(e=>{"Server reached maximum concurrent capacity"===e&&u(2,null,"exception"),"Query param 'caseId' was not found"===e&&u(2,null,"exception")})),t.on(e.faceImage,(e=>{o=e})),r.then((()=>{t.bindContainer(document.getElementById("livenessContainer"))})),t.on(e.status,(e=>{switch(e){case 0:t.stopProcessingEverythingAndDisconnect(),u(1,o=o.replace("data:image/jpeg;base64,",""),"SUCCESS");break;case 1:t.stopProcessingEverythingAndDisconnect(),console.log("Liveness Fail"),u(2,null,"livenessFailed");break;case 8:t.stopProcessingEverythingAndDisconnect(),console.log("Liveness TimeOut"),u(2,null,"livenessTimeout")}})),t.on("error",(e=>{e&&e.name&&["NotFoundError","DevicesNotFoundError","NotReadableError","TrackStartError","OverconstrainedError","ConstraintNotSatisfiedError","NotAllowedError","PermissionDeniedError"].includes(e.name)&&(t.stopProcessingEverythingAndDisconnect(),u(2,null,"canNotOpenCamera"))})),t.on(e.serverError,(e=>{console.log(`serverError (${e.code})`),u(2,null,"exception")}))}catch(e){u(2,null,"exception")}}}